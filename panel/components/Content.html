<script>
    import { onMount } from "svelte";
    import { slide } from "svelte/transition";

    const SCRIPT_KEY = "script";
    const SCRIPT_NAME_KEY = "scriptName";

    export let activeSection;
    let configEntries = [];
    let configSearchterm = "";

    let scripts = [];
    let currentScript = localStorage.getItem(SCRIPT_KEY) || "";
    let currentScriptName = localStorage.getItem(SCRIPT_NAME_KEY) || "";
    let scriptNameError = true;
    let scriptResult = null;

    $: localStorage.setItem(SCRIPT_KEY, currentScript);
    $: localStorage.setItem(SCRIPT_NAME_KEY, currentScriptName);

    onMount(() => {
        fetchConfig();
        fetchScripts();
    });

    async function fetchConfig() {
        const res = await fetch("config");
        if (res.ok) {
            const config = await res.json();
            configEntries = Object.entries(config).sort((a, b) => a[0].localeCompare(b[0])).map(e => { e[1].value = valueToString(e[1].value); return e; });
        } else {
            console.error(await res.json());
        }
    }

    async function fetchScripts() {
        const res = await fetch("script/list");
        if (res.ok) {
            scripts = await res.json();
        } else {
            console.error(await res.json());
        }
    }

    async function runScript() {
        const res = await fetch("script/run", { method: "POST", headers: { "content-type": "application/json" }, body: JSON.stringify({ script: currentScript }) });
        if (res.ok || true) {
            scriptResult = JSON.stringify(await res.json());
        } else {
            console.error(await res.json());
        }
    }

    async function saveScript() {
        const res = await fetch("script/save", { method: "POST", headers: { "content-type": "application/json" }, body: JSON.stringify({ script: currentScript, name: currentScriptName }) });
        if (res.ok) {
            console.log(await res.json());
        } else {
            console.error(await res.json());
        }
        fetchScripts()
    }

    async function saveConfig(key, value) {
        const res = await fetch("config/" + key, { method: "PUT", headers: { "content-type": "application/json" }, body: JSON.stringify({ value }) });
        if (res.ok) {
            console.log(await res.json());
        } else {
            console.error(await res.json());
        }
    }

    function valueToString(val) {
        const type = typeof val;
        if (Array.isArray(val)) {
            return val.join(",");
        } else if (typeof val === "object") {
            return JSON.stringify(val);
        } else {
            return String(val);
        }
    }
</script>

<style>
    .scripts {
        max-height: 500px;
    }

    .scripts .is-narrow {
        overflow-y: auto;
    }

    .scripts .script {
        cursor: pointer;
    }

    .scripts .script:hover {
        background-color: rgba(0, 0, 0, 0.1);
    }

    .mono {
        font-family: monospace;
    }
</style>

<div class="column pt-6">
    <h2 class="title is-4">{activeSection}</h2>
    {#if activeSection === "Application"}
    <h5 class="title is-5">Script</h5>
    <div class="columns scripts">
        <div class="column is-three-quarters">
            <textarea rows="10" class="textarea is-small mono" bind:value="{currentScript}"
                on:keyup="{e=>e.ctrlKey&&e.key==='Enter'&&runScript()}"></textarea>
            <div class="level mt-2">
                <div class="level-left">
                    <div class="level-item">
                        <div class="field has-addons">
                            <div class="control">
                                <input type="text" class="input" bind:value="{currentScriptName}" placeholder="Name"
                                    class:is-danger="{scriptNameError}" on:input="{()=>scriptNameError=false}">
                            </div>
                            <div class="control">
                                <button class="button" on:click="{saveScript}">Save</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="level-right">
                    <div class="level-item">
                        <div class="field">
                            <div class="control">
                                <button class="button" on:click="{runScript}">Run</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="column">
            {#each scripts as {name,script} (name) }
            <div class="script p-1" on:click="{()=>{currentScript=script;currentScriptName=name}}">
                <p><b>{name}</b></p>
                <p class="help mono">{script.slice(0,15)+"..."}</p>
            </div>
            {/each}
        </div>
    </div>
    {#if scriptResult}
    <div class="result">{scriptResult}</div>
    {/if}
    {:else if activeSection === "Action"}
    <p>Marvel</p>
    {:else if activeSection === "Configuration"}
    <div><button class="button is-info is-light" on:click="{fetchConfig}">Refresh Config</button></div>
    <input type="text" class="input" placeholder="Search" bind:value="{configSearchterm}">
    {JSON.stringify(configEntries)}
    {#each configEntries as [k,v] (k)}
    {#if !configSearchterm || k.includes(configSearchterm)}
    <div class="field is-horizontal">
        <div class="field-label is-normal">
            <label class="label">{k}</label>
        </div>
        <div class="field-body">
            <div class="field">
                <div class="control">
                    {#if v.values && v.values.length && v.values.length>1}
                    <div class="select">
                        <select bind:value="{v.value}">
                            {#if !v.values.includes(v.value) }
                            <option selected>{v.value}</option>
                            {/if}
                            {#each v.values as vv }
                            <option>{vv}</option>
                            {/each}
                        </select>
                    </div>
                    {:else}
                    <input type="text" class="input" bind:value="{v.value}">
                    {/if}
                </div>
                {#if v.description}
                <p class="help">{v.description}</p>
                {/if}
            </div>
            <div class="field">
                <div class="control">
                    <button class="button" on:click="{()=>saveConfig(k,v.value)}">Save</button>
                </div>
            </div>
        </div>
    </div>
    {/if}
    {/each}
    {:else if activeSection === "System"}
    <p>Processor</p>
    {:else}
    <p>Unknown section</p>
    {/if}
</div>